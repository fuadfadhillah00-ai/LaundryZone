<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LaundryZone</title>
  <style>
    /* ========= THEME ========= */
    :root{
      --blue:#0B63CE; --blue-2:#2A7FF0; --blue-dark:#084c9e; --blue-soft:#e8f1ff;
      --white:#ffffff; --gray-1:#f5f7fb; --gray-2:#e6e9ef; --gray-3:#c9d2de;
      --text:#102a43; --muted:#627d98; --success:#198754; --danger:#d9534f;
      --shadow:0 12px 22px rgba(11,99,206,.12); --radius:18px; --overlay:rgba(16,42,67,.35);
    }
    [data-theme="dark"]{
      --blue:#2A7FF0; --blue-2:#66A7FF; --blue-dark:#1b63c7; --blue-soft:#0b63ce18;
      --white:#0f1723; --gray-1:#0b111b; --gray-2:#152233; --gray-3:#27405a;
      --text:#e6edf6; --muted:#9fb2c6; --overlay:rgba(0,0,0,.5);
      --shadow:0 12px 24px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--gray-1);color:var(--text);overflow-x:hidden;transition:background .3s,color .3s}
    a{color:var(--blue);text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}

    /* ========= NAV ========= */
    .nav{position:sticky;top:0;background:linear-gradient(180deg,var(--white),#ffffffd9);backdrop-filter:blur(8px);border-bottom:1px solid var(--gray-2);z-index:20}
    .nav-inner{display:flex;justify-content:space-between;align-items:center;padding:12px 0}
    .brand{display:flex;align-items:center;gap:.7rem;font-weight:900;color:var(--blue)}
    .brand .logo{width:40px;height:40px;object-fit:contain;
    .menu{position:relative;display:flex;gap:6px;flex-wrap:wrap}
    .menu button{background:transparent;border:0;padding:.7rem 1rem;border-radius:12px;color:var(--muted);cursor:pointer;font-weight:700;transition:.25s}
    .menu button.active,.menu button:hover{color:var(--blue);}
    .menu .ink{position:absolute;bottom:0;height:3px;background:var(--blue);border-radius:999px;transition:all .25s ease}
    .right-actions{display:flex;align-items:center;gap:10px}

    .toggle{display:inline-flex;align-items:center;gap:8px;padding:.4rem .7rem;border:1px solid var(--gray-2);border-radius:999px;cursor:pointer}

    /* ========= LAYOUT ========= */
    .card{background:var(--white);border:1px solid var(--gray-2);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;transition:.35s;opacity:0;transform:translateY(18px)}
    .card.show{opacity:1;transform:translateY(0)}
    .grid{display:grid;gap:18px}
    .grid.cols-2{grid-template-columns:repeat(2,1fr)}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    @media(max-width:1080px){.grid.cols-4{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:980px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

    h1{font-size:1.9rem;margin-bottom:6px}
    h2{font-size:1.15rem;color:var(--muted)}
    h3{margin-bottom:6px}
    .chip{padding:.35rem .7rem;background:var(--blue-soft);color:var(--blue);border-radius:999px;font-size:.75rem;font-weight:700;display:inline-block}
    .field{display:grid;gap:6px;margin-top:8px}
    .input,select,textarea{padding:.75rem;border-radius:14px;border:1px solid var(--gray-2);background:transparent;color:inherit}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.85rem 1.2rem;border-radius:14px;border:1px solid transparent;background:var(--blue);color:#fff;cursor:pointer;font-weight:700;box-shadow:var(--shadow);transition:.25s;transform:translateY(0)}
    .btn:hover{background:var(--blue-dark);transform:translateY(-2px)}
    .btn.secondary{background:transparent;color:var(--blue);border-color:var(--blue)}
    .btn.icon{padding:.5rem .7rem}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--gray-2);padding:.3rem .6rem;border-radius:999px}

    .footer{margin-top:40px;padding:20px 0;border-top:1px solid var(--gray-2);color:var(--muted);text-align:center}

    /* ========= TOAST / NOTIF ========= */
    .toast{position:fixed;bottom:20px;right:20px;background:var(--blue);color:#fff;padding:12px 18px;border-radius:12px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:.35s;z-index:40}
    .toast.show{opacity:1;pointer-events:auto}
    .notif-bubble{position:fixed;top:86px;right:20px;display:grid;gap:10px;z-index:30}
    .notif{background:var(--white);border:1px solid var(--gray-2);box-shadow:var(--shadow);border-radius:12px;padding:10px 12px;font-size:.9rem;animation:slideIn .35s}

    /* ========= TRACKER ========= */
    .steps{display:flex;gap:10px;align-items:center;margin:10px 0}
    .step{flex:1;height:6px;background:var(--gray-2);border-radius:6px;position:relative}
    .step::after{content:"";position:absolute;inset:0;width:0;background:var(--blue-2);border-radius:6px;transition:width .5s}
    .step.done::after{width:100%}
    .status{padding:.35rem .7rem;border-radius:999px;font-size:.8rem;font-weight:700;background:var(--blue-soft);color:var(--blue)}
    .progress{width:100%;height:10px;background:var(--gray-2);border-radius:8px;overflow:hidden;margin-top:6px}
    .progress-bar{height:10px;background:var(--blue);width:0;transition:width .6s ease}

    /* ========= MAP ========= */
    .map{position:relative;width:100%;height:340px;background:linear-gradient(135deg,#eaf3ff,#f7fbff);border:1px dashed var(--blue);border-radius:var(--radius);margin-top:14px;overflow:hidden;touch-action:pan-x pan-y}
    .gridline{position:absolute;left:0;top:0;right:0;bottom:0;background-image:linear-gradient(to right, rgba(10,99,206,.08) 1px, transparent 1px),linear-gradient(to bottom, rgba(10,99,206,.08) 1px, transparent 1px);background-size:40px 40px;pointer-events:none}
    .marker{position:absolute;width:24px;height:24px;background:var(--blue);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.85rem;transform:translate(-50%,-50%);cursor:grab}
    .marker:active{cursor:grabbing}
    .marker.poi{background:#fff;color:var(--blue);border:2px solid var(--blue);font-size:1rem}
    .eta{position:absolute;bottom:10px;left:10px;background:var(--white);border:1px solid var(--gray-2);border-radius:10px;padding:6px 10px;box-shadow:var(--shadow)}
    svg.route{position:absolute;inset:0}

    /* ========= CHAT ========= */
    .chat{display:flex;flex-direction:column;height:260px;border:1px solid var(--gray-2);border-radius:14px;overflow:hidden}
    .chat-log{flex:1;background:var(--white);padding:12px;overflow:auto}
    .msg{max-width:80%;padding:10px 12px;border-radius:14px;margin:6px 0;box-shadow:var(--shadow)}
    .me{background:var(--blue);color:#fff;margin-left:auto;border-bottom-right-radius:4px}
    .them{background:#fff;border:1px solid var(--gray-2);color:var(--text);border-bottom-left-radius:4px}
    .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid var(--gray-2);background:var(--white)}
    .chat-input input{flex:1}

    /* ========= MODAL ========= */
    .modal{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:50}
    .modal .panel{background:var(--white);border:1px solid var(--gray-2);border-radius:18px;padding:20px;min-width:320px;max-width:520px;box-shadow:var(--shadow)}

    /* ========= CARDS / LIST ========= */
    .hlist{display:flex;gap:12px;overflow:auto;padding-bottom:6px}
    .shop-card{min-width:260px;display:flex;flex-direction:column;gap:6px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}

    /* ========= REWARD ========= */
    .reward{display:flex;align-items:center;gap:12px}
    .badge{padding:.2rem .5rem;border-radius:999px;border:1px solid var(--gray-2)}

    /* ========= ANIMATIONS ========= */
    @keyframes slideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .slide{animation:slideIn .35s ease}
  </style>
</head>
<body>
  <header class="nav">
    <div class="container nav-inner">
    <div class="brand"><img src="https://i.imgur.com/pH0NvnY.png" class="logo" alt="LaundryZone">LaundryZone</div>
      <nav class="menu" id="mainMenu">
        <button data-view="home" class="active">Beranda</button>
        <button data-view="order">Pesan</button>
        <button data-view="orders">Pesanan</button>
        <button data-view="promos">Promo</button>
        <button data-view="subscription">Langganan</button>
        <button data-view="favorites">Favorit</button>
        <button data-view="support">Bantuan</button>
        <div class="ink" id="ink"></div>
      </nav>
      <div class="right-actions">
        <label class="toggle"><input type="checkbox" id="themeToggle"> <span>üåô Dark</span></label>
        <div class="pill"><span id="langBtn" style="cursor:pointer">üáÆüá© ID</span></div>
      </div>
    </div>
  </header>

  <main class="container" id="app"></main>
  <footer class="container footer">¬© 2025 LaundryZone ‚Äî Aplikasi Pelanggan</footer>
  <div class="toast" id="toast" role="status" aria-live="polite"></div>
  <div class="notif-bubble" id="notif"></div>

  <div class="modal" id="payModal" aria-modal="true" role="dialog">
    <div class="panel">
      <h3>Bayar dengan QR</h3>
      <canvas id="qr" width="240" height="240" style="border-radius:12px;border:1px solid var(--gray-2);"></canvas>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="btn" onclick="toast('Pembayaran terverifikasi ‚úÖ'); togglePay(false)">Saya Sudah Bayar</button>
        <button class="btn secondary" onclick="togglePay(false)">Tutup</button>
      </div>
    </div>
  </div>

  <!-- Modal: Chat Laundry (baru) -->
  <div class="modal" id="laundryChatModal" aria-modal="true" role="dialog">
    <div class="panel">
      <h3 id="laundryChatTitle">Chat Laundry</h3>
      <div class="chat" style="height:300px">
        <div class="chat-log" id="laundryChatLog"></div>
        <div class="chat-input">
          <input id="laundryChatTxt" class="input" placeholder="Tulis pesan untuk laundry..." onkeydown="if(event.key==='Enter'){sendLaundryMsg()}">
          <button class="btn" onclick="sendLaundryMsg()">Kirim</button>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
        <button class="btn secondary" onclick="toggleLaundryChat(false)">Tutup</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Utilities
    const $ = (s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const toast=(m)=>{const t=$('#toast');t.textContent=m;t.classList.add('show');clearTimeout(t.__to);t.__to=setTimeout(()=>t.classList.remove('show'),3000);};
    const notify=(m)=>{const n=$('#notif');const d=document.createElement('div');d.className='notif';d.textContent=m;n.appendChild(d);setTimeout(()=>{d.remove()},4000)}
    const saveLS=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const loadLS=(k,def)=>{try{const v=JSON.parse(localStorage.getItem(k)); return v??def}catch{return def}}

    // ===== i18n (sederhana)
    let LANG=loadLS('LANG','id');
    const dict={
      id:{homeTitle:'Tinggal klik, kami jemput & antar.',homeSub:'Pesan laundry terdekat berbasis GPS, chat kurir, dan pembayaran fleksibel.'},
      en:{homeTitle:'Just tap, we pick up & deliver.',homeSub:'Order nearby laundry with GPS tracking, courier chat, and flexible payment.'}
    }

    // ===== State
    let currentView='home';
    let orders=loadLS('orders',[]);
    const statuses=['Dijemput','Diproses','Diantar','Selesai'];
    let routePts=[[120,260],[420,160],[120,260]];
    let homePt=[120,260];
    let laundryPt=[420,160];
    let courier={el:null, progress:0, active:false};
    let favorites=loadLS('favorites',[]);

    const shops=[
      {id:'lz-01',name:'Clean&Fresh Sudirman',dist:1.2,rating:4.8,promo:'Diskon 20%',services:['Kiloan','Express','Sepatu'],logo:'üß¥'},
      {id:'lz-02',name:'Laundry Cepat Benhil',dist:0.9,rating:4.6,promo:'Gratis Antar',services:['Kiloan','Jas','Dry Clean'],logo:'‚ö°'},
      {id:'lz-03',name:'Cerah Cemerlang',dist:2.1,rating:4.9,promo:'Cashback 10%',services:['Kiloan','Sepatu'],logo:'‚ú®'},
      {id:'lz-04',name:'Express Kiloan Suites',dist:1.7,rating:4.5,promo:'Bundle Hemat',services:['Kiloan','Express','Jas'],logo:'üßº'}
    ];

    // ===== Navigation + Ink underline
    function moveInk(btn){const ink=$('#ink');const r=btn.getBoundingClientRect();const pr=btn.parentElement.getBoundingClientRect();ink.style.width=r.width+'px';ink.style.left=(r.left-pr.left)+'px'}
    function navigate(v,animate=true){currentView=v;render(animate);$$('#mainMenu button').forEach(b=>{b.classList.toggle('active',b.dataset.view===v); if(b.dataset.view===v) moveInk(b)});}

    // ===== Theme & Lang with persistence
    const themeToggle=$('#themeToggle');
    function applyTheme(){document.body.setAttribute('data-theme', themeToggle.checked?'dark':'light'); saveLS('THEME_DARK',themeToggle.checked)}
    themeToggle.addEventListener('change',applyTheme);
    $('#langBtn').addEventListener('click',()=>{LANG=LANG==='id'?'en':'id'; $('#langBtn').textContent = LANG==='id'?'üáÆüá© ID':'üá¨üáß EN'; saveLS('LANG',LANG); render();});

    // ===== Shared rendering helpers
    function animateCards(){ $$('.card').forEach((c,i)=> setTimeout(()=>c.classList.add('show'),80*i) ); }
    function star(n){return '‚òÖ'.repeat(Math.round(n))+'‚òÜ'.repeat(5-Math.round(n));}

    // ===== Pages
    let currentOrderId = null; // Untuk detail pesanan

    function render(animate=true){
      const app=$('#app');
      if(currentView==='home') {
        app.innerHTML=`<section class='grid cols-2 ${animate?'slide':''}' style='margin-top:20px'>
          <div class='card'>
            <h1>${dict[LANG].homeTitle}</h1>
            <h2>${dict[LANG].homeSub}</h2>
            <div class='grid cols-4' style='margin-top:14px'>
              ${[
                {t:'Kiloan',i:'üß∫'},{t:'Express',i:'‚ö°'},{t:'Cuci Sepatu',i:'üëü'},{t:'Cuci Jas',i:'ü§µ'},{t:'Dry Clean',i:'üß•'},{t:'Setrika',i:'üßØ'},{t:'Bed Cover',i:'üõèÔ∏è'},{t:'Karpet',i:'üßΩ'}
              ].map(s=>`<div class='pill'><span>${s.i}</span><b>${s.t}</b></div>`).join('')}
            </div>
            <button class='btn' style='margin-top:14px' onclick="navigate('order')">Mulai Pesan</button>
          </div>
          <div class='card'>
            <h3>Laundry Rekomendasi Dekat Anda</h3>
            <div class='grid cols-2' style='margin-top:6px'>
              ${shops.map(sh=>shopCard(sh)).join('')}
            </div>
          </div>
        </section>`;
        attachFavHandlers();
      }

      if(currentView==='order'){
        app.innerHTML=`<div class='grid cols-2 ${animate?'slide':''}' style='margin-top:20px'>
          <div class='card'>
            <h1>Pemesanan</h1>
            <div class='field'><label>Layanan</label>
              <select id='service' class='input'>
                <option>Kiloan</option>
                <option>Express</option>
                <option>Satuan</option>
                <option>Cuci Sepatu</option>
                <option>Cuci Jas</option>
                <option>Dry Clean</option>
              </select>
            </div>
            <div class='field'><label>Alamat</label><input id='address' class='input' placeholder='Alamat lengkap'></div>
            <div class='field'><label>Jadwal</label><input type='date' id='date' class='input'></div>
            <div class='field'><label>Metode Pembayaran</label><select id='pay' class='input'><option>Transfer</option><option>E-Wallet</option><option>COD</option></select></div>
            <div class='field'><label>Catatan</label><textarea id='note' class='input' placeholder='Preferensi parfum, lipatan, dll.'></textarea></div>
            <div class='row' style='margin-top:6px'>
              <button class='btn' onclick='makeOrder()'>Konfirmasi Pesan</button>
              <button class='btn secondary' onclick='togglePay(true)'>Simulasi Pembayaran</button>
            </div>
          </div>
          <div class='card'>
            <h3>Simulasi Biaya</h3>
            <div class='field'><label>Berat (kg) / Item</label><input id='kg' class='input' type='number' min='1' value='5'></div>
            <div class='field'><label>Jenis</label><select id='jenis' class='input'>
              <option>Reguler</option><option>Express</option><option>Sepatu</option><option>Jas</option><option>Dry Clean</option>
            </select></div>
            <div class='notice' id='calc'>Perkiraan: Rp0</div>
            <button class='btn secondary' style='margin-top:10px' onclick='calcPrice()'>Hitung</button>
            <div class='reward' style='margin-top:12px'>
              <span class='badge'>Level: <b id='levelBadge'>Bronze</b></span>
              <div style='flex:1'>
                <div class='progress'><div class='progress-bar' id='rewardBar'></div></div>
                <small class='muted'>Poin: <b id='points'>0</b> / 100</small>
              </div>
            </div>
          </div>
        </div>`;
        updateRewardUI();
      }

      if(currentView==='profile'){
        const sh=shops.find(s=>s.id===window.__profileId);
        if(!sh){navigate('home');return}
        app.innerHTML=`<div class='grid cols-2 ${animate?'slide':''}' style='margin-top:20px'>
          <div class='card'>
            <div class='row'>
              <div class='pill'><span style='font-size:1.4rem'>${sh.logo}</span><b>${sh.name}</b></div>
              <button class='btn icon' data-fav='${sh.id}'>${isFav(sh.id)?'‚ù§Ô∏è':'ü§ç'}</button>
            </div>
            <p class='chip' style='margin-top:6px'>${sh.dist} km ‚Ä¢ ‚≠ê ${sh.rating} ‚Ä¢ ${sh.promo}</p>
            <h3 style='margin-top:10px'>Layanan</h3>
            <div class='grid cols-4' style='margin-top:6px'>${sh.services.map(s=>`<div class='pill'>${iconFor(s)}<b>${s}</b></div>`).join('')}</div>
            <div class='row' style='margin-top:12px; gap:10px'>
              <button class='btn' onclick="prefillShop('${sh.name}')">Pesan di sini</button>
              <button class='btn secondary' onclick="openLaundryChat('${sh.id}','${sh.name}')">Chat Laundry</button>
            </div>
          </div>
          <div class='card'>
            <h3>Ulasan</h3>
            <div class='notice'>‚ÄúRapi, wangi, tepat waktu!‚Äù ‚Äî 1.2k ulasan</div>
            <h3 style='margin-top:10px'>Harga (dummy)</h3>
            <div class='grid cols-2'>
              <div class='notice'>Kiloan: Rp7.000/kg<br>Express: Rp10.000/kg</div>
              <div class='notice'>Sepatu: Rp25.000/psg<br>Jas/Dry Clean: Rp40.000/item</div>
            </div>
          </div>
        </div>`;
        attachFavHandlers();
      }

      if(currentView==='orders'){
        app.innerHTML = `<div class='card ${animate?'slide':''}' style='margin-top:20px'>
          <h1>Daftar Pesanan</h1>
          <div>
            ${orders.length ? orders.map(ord => `
              <div class="pill" style="margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;gap:10px;">
                <div>
                  <b>${ord.id}</b> &bull; ${ord.service} &bull; ${ord.address} 
                  <span class="chip" style="margin-left:10px;color:${ord.status==='ongoing'?'var(--blue)':'var(--muted)'}">${ord.status==='ongoing'?'Sedang Proses':'Selesai'}</span>
                </div>
                <button class="btn secondary" onclick="openOrderDetail('${ord.id}')">Lihat</button>
              </div>
            `).join('') : '<div class="notice">Belum ada pesanan.</div>'}
          </div>
        </div>`;
      }

      if(currentView==='orderDetail'){
        const ord = orders.find(o=>o.id===currentOrderId);
        if(!ord){navigate('orders');return;}
        let detailHTML = `
          <div class="card ${animate?'slide':''}" style="margin-top:20px">
            <h1>Detail Pesanan</h1>
            <div><b>ID:</b> ${ord.id}</div>
            <div><b>Layanan:</b> ${ord.service}</div>
            <div><b>Alamat:</b> ${ord.address}</div>
            <div><b>Status:</b> <span class="chip" style="color:${ord.status==='ongoing'?'var(--blue)':'var(--muted)'}">${ord.status==='ongoing'?'Sedang Proses':'Selesai'}</span></div>
            <div style="margin-top:16px">
              <button class="btn secondary" onclick="navigate('orders')">Kembali</button>
            </div>
          </div>
        `;
        if(ord.status === 'ongoing'){
          detailHTML += `
          <div class="card ${animate?'slide':''}" style="margin-top:20px">
            <h3>Lacak Pesanan</h3>
            <div class='steps'>${[0,1,2,3].map(i=>`<div class='step' data-step='${i}'></div>`).join('')}</div>
            <div class='progress'><div class='progress-bar' id='prog'></div></div>
            <div class='map' id='map'>
              <div class='gridline'></div>
              <svg class='route' viewBox='0 0 800 340' preserveAspectRatio='none'>
                <polyline id='routeMain' fill='none' stroke='var(--blue-2)' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/>
              </svg>
              <div class='marker poi' id='home' style='left:${homePt[0]}px;top:${homePt[1]}px'>üè†</div>
              <div class='marker poi' id='laundry' style='left:${laundryPt[0]}px;top:${laundryPt[1]}px'>üß∫</div>
              <div class='marker' id='truck'>üöö</div>
              <div class='eta' id='eta'>ETA: ‚Äî menit</div>
            </div>
            <div style='display:flex;gap:10px;margin-top:10px;flex-wrap:wrap'>
              <button class='btn secondary' onclick='startRideDetail()'>Mulai Rute</button>
              <button class='btn secondary' onclick='pauseRideDetail()'>Jeda</button>
              <button class='btn secondary' onclick='resetRideDetail()'>Reset</button>
            </div>
          </div>
          <div class='card' style='margin-top:20px'>
            <h3>Chat Kurir</h3>
            <div class='chat'>
              <div class='chat-log' id='chatLog'></div>
              <div class='chat-input'>
                <input id='chatTxt' class='input' placeholder='Tulis pesan ke kurir...'>
                <button class='btn' onclick='sendMsg()'>Kirim</button>
              </div>
            </div>
          </div>
          `;
          setTimeout(()=>{
            initMapInteractions();
            updateRoutes();
            courier.el=$('#truck');
            courier.progress = ord.progress || 0;
            updateProgressUI();
            updateETA();
            presetChat();
          },50);
        }
        app.innerHTML = `<div class="grid cols-2">${detailHTML}</div>`;
      }

      if(currentView==='promos'){
        app.innerHTML=`<div class='grid cols-3 ${animate?'slide':''}' style='margin-top:20px'>
          ${[
            {c:'WELCOME50',d:'Diskon 50% order pertama.'},
            {c:'EXPRESS10',d:'Diskon 10% layanan express.'},
            {c:'BUNDLEFREE',d:'Gratis jemput-antar untuk paket langganan.'}
          ].map(p=>`<div class='card'><h3>${p.c}</h3><p>${p.d}</p><button class='btn secondary' onclick="toast('Promo ${p.c} digunakan')">Gunakan</button></div>`).join('')}
        </div>`;
      }

      if(currentView==='subscription'){
        app.innerHTML=`<div class='grid cols-3 ${animate?'slide':''}' style='margin-top:20px'>
          <div class='card'><h3>Paket Hemat</h3><p>Rp99rb/bln</p><p class='chip'>4x kiloan + antar</p><button class='btn' onclick="toast('Langganan Paket Hemat aktif')">Langganan</button></div>
          <div class='card'><h3>Paket Hemat 20</h3><p>Rp179rb/bln</p><p class='chip'>8x kiloan + 1x express</p><button class='btn' onclick="toast('Langganan Paket Hemat 20 aktif')">Langganan</button></div>
          <div class='card'><h3>Kantoran</h3><p>Rp499rb/bln</p><p class='chip'>Kuota 25kg + laporan</p><button class='btn' onclick="toast('Langganan Paket Kantoran aktif')">Langganan</button></div>
        </div>`;
      }

      if(currentView==='favorites'){
        const favs=shops.filter(s=>favorites.includes(s.id));
        app.innerHTML=`<div class='card ${animate?'slide':''}' style='margin-top:20px'>
          <h1>Favorit</h1>
          <div class='grid cols-2' style='margin-top:10px'>${favs.length?favs.map(s=>shopCard(s)).join(''):'<div class="notice">Belum ada favorit.</div>'}</div>
        </div>`; attachFavHandlers();
      }

      if(currentView==='support'){
        app.innerHTML=`<div class='grid cols-2 ${animate?'slide':''}' style='margin-top:20px'>
          <div class='card'><h1>FAQ</h1>
            <details open><summary>Bagaimana cara pesan?</summary><p>Pilih menu Pesan, isi detail, konfirmasi.</p></details>
            <details><summary>Metode pembayaran?</summary><p>Transfer, e-wallet, COD.</p></details>
            <details><summary>Pelacakan & ETA?</summary><p>Lihat menu Pesanan, pilih pesanan yang sedang berlangsung untuk fitur lacak.</p></details>
          </div>
          <div class='card'><h1>Kontak</h1>
            <div class='field'><label>Email</label><input class='input'></div>
            <div class='field'><label>Pesan</label><textarea class='input'></textarea></div>
            <button class='btn' style='margin-top:10px' onclick="toast('Pesan terkirim!')">Kirim</button>
          </div>
        </div>`;
      }

      animateCards();
    }

    // ===== Helpers UI
    function iconFor(s){const map={Kiloan:'üß∫',Express:'‚ö°',Sepatu:'üëü','Cuci Sepatu':'üëü','Cuci Jas':'ü§µ','Dry Clean':'üß•','Jas':'ü§µ'};return `<span>${map[s]||'üßº'}</span>`}

    function shopCard(sh){return `<div class='card shop-card'>
      <div class='row'><div class='pill'><span style='font-size:1.4rem'>${sh.logo}</span><b>${sh.name}</b></div>
      <button class='btn icon' data-fav='${sh.id}'>${isFav(sh.id)?'‚ù§Ô∏è':'ü§ç'}</button></div>
      <div class='row'><span>‚≠ê ${sh.rating}</span><span>${sh.dist} km</span></div>
      <div class='chip'>${sh.promo}</div>
      <div class='row' style='gap:10px'>
        <button class='btn secondary' onclick="openProfile('${sh.id}')">Lihat Profil</button>
        <button class='btn secondary' onclick="openLaundryChat('${sh.id}','${sh.name}')">Chat</button>
      </div>
    </div>`}

    function isFav(id){return favorites.includes(id)}
    function toggleFav(id){ if(isFav(id)) favorites=favorites.filter(x=>x!==id); else favorites.push(id); saveLS('favorites',favorites); render(false); }
    function attachFavHandlers(){ $$('[data-fav]').forEach(b=> b.onclick=()=>toggleFav(b.getAttribute('data-fav')) ); }

    // ===== Order, Reward & Calculator
    let rewardPts=loadLS('rewardPts',0);
    function updateRewardUI(){ const level= rewardPts>=300?'Gold':rewardPts>=150?'Silver':'Bronze'; $('#levelBadge').textContent=level; $('#points').textContent=rewardPts; $('#rewardBar').style.width= (rewardPts%100)+'%'; }
    function addReward(n){ rewardPts+=n; saveLS('rewardPts',rewardPts); updateRewardUI(); }

    function makeOrder(){
      const id='LZ-'+Math.floor(Math.random()*100000);
      orders.push({
        id,
        service:$('#service').value,
        address:$('#address').value,
        date:$('#date').value,
        pay:$('#pay').value,
        note:$('#note').value,
        status:'ongoing',
        progress:0
      });
      saveLS('orders',orders);
      toast('Pesanan '+id+' dibuat');
      addReward(10);
      courier.progress=0; courier.active=false;
      navigate('orders');
      notify('Kurir menerima pesanan üöö');
    }
    function calcPrice(){
      const qty=parseFloat($('#kg').value||0); const jenis=$('#jenis').value; let price=0;
      if(jenis==='Reguler') price=qty*7000; else if(jenis==='Express') price=qty*10000; else if(jenis==='Sepatu') price=qty*25000; else if(jenis==='Jas') price=qty*40000; else if(jenis==='Dry Clean') price=qty*40000;
      price=Math.max(0, Math.round(price/1000)*1000); $('#calc').textContent='Perkiraan: Rp'+ price.toLocaleString('id-ID');
    }

    // ===== Profile helpers
    function openProfile(id){ window.__profileId=id; navigate('profile'); }
    function prefillShop(name){ navigate('order'); setTimeout(()=>{ $('#address').value=name+' (ambil di toko)'; toast('Alamat diisi dari profil: '+name); },50); }

    // ===== Pesanan detail helpers
    function openOrderDetail(id){ currentOrderId = id; navigate('orderDetail'); }
    function setOrderProgress(orderId, progress){
      const ord = orders.find(o => o.id === orderId);
      if (ord) {
        ord.progress = progress;
        if (progress >= 1) ord.status = 'done';
        saveLS('orders', orders);
      }
    }

    // ===== Tracker & Map (Customer Centric: rumah ‚Üí laundry ‚Üí rumah)
    function updateProgressUI(){ 
      const ord = orders.find(o=>o.id===currentOrderId);
      const p = ord ? Math.min(100, Math.round((ord.progress||0)*100)) : Math.min(100, Math.round(courier.progress*100));
      $('#prog').style.width=(p)+'%';
      const steps=$$('.step');
      const badge=$('#statusBadge');
      let label=statuses[0];
      if(p<45){ label=statuses[0]; } // menuju laundry
      else if(p>=45 && p<55){ label=statuses[1]; } // di laundry
      else if(p>=55 && p<100){ label=statuses[2]; } // menuju rumah
      else { label=statuses[3]; }
      if(badge) badge.textContent=label;
      steps.forEach((s,i)=> s.classList.toggle('done', (i*33) <= p));
    }

    function initMapInteractions(){
      const home=$('#home'); const laund=$('#laundry'); const map=$('#map');
      ;[home,laund].forEach(el=>{
        el.addEventListener('pointerdown',e=>{el.setPointerCapture(e.pointerId); el.__drag=true});
        el.addEventListener('pointermove',e=>{if(!el.__drag) return; const r=map.getBoundingClientRect(); const x=Math.min(Math.max(e.clientX-r.left,10),r.width-10); const y=Math.min(Math.max(e.clientY-r.top,10),r.height-10); el.style.left=x+'px'; el.style.top=y+'px'; updateRoutes(); updateETA();});
        el.addEventListener('pointerup',()=>{el.__drag=false; notify('Lokasi diperbarui üìç')});
      });
      let pan=false, sx=0, sy=0; const grid=$('.gridline',map);
      map.addEventListener('pointerdown',e=>{if(e.target.classList.contains('marker')) return; pan=true; sx=e.clientX; sy=e.clientY;});
      map.addEventListener('pointermove',e=>{ if(!pan) return; grid.style.backgroundPosition = `${(e.clientX-sx)/2}px ${(e.clientY-sy)/2}px`; });
      map.addEventListener('pointerup',()=> pan=false);
    }

    function getPt(el){ return [parseFloat(el.style.left), parseFloat(el.style.top)]; }
    function updateRoutes(){
      homePt=getPt($('#home')); laundryPt=getPt($('#laundry'));
      const mid1=[ (homePt[0]+laundryPt[0])/2, (homePt[1]+laundryPt[1])/2 - 20];
      const mid2=[ (homePt[0]+laundryPt[0])/2, (homePt[1]+laundryPt[1])/2 + 10];
      routePts=[homePt, mid1, laundryPt, mid2, homePt];
      $('#routeMain').setAttribute('points', routePts.map(pt=>pt.join(',')).join(' '));
      positionOnRoute($('#truck'), routePts, courier.progress);
    }
    function routeLength(pts){ let L=0; for(let i=0;i<pts.length-1;i++){const a=pts[i], b=pts[i+1]; L+=Math.hypot(b[0]-a[0], b[1]-a[1]); } return L; }
    function pointAt(pts,t){ const total=routeLength(pts); let d=t*total; for(let i=0;i<pts.length-1;i++){ const a=pts[i], b=pts[i+1]; const seg=Math.hypot(b[0]-a[0], b[1]-a[1]); if(d<=seg){ const r=d/seg; return [a[0]+(b[0]-a[0])*r, a[1]+(b[1]-a[1])*r]; } d-=seg; } return pts[pts.length-1]; }
    function positionOnRoute(el,pts,t){ const [x,y]=pointAt(pts,t); el.style.left=x+'px'; el.style.top=y+'px'; }

    let rideTimerDetail=null; const BASE_PX_PER_MIN=140;
    function startRideDetail(){
      clearInterval(rideTimerDetail);
      courier.active=true;
      notify('Kurir sedang menuju laundry üöö');
      rideTimerDetail=setInterval(()=>{
        const speed=0.01;
        if(courier.active){
          courier.progress = Math.min(1, courier.progress+speed);
          positionOnRoute(courier.el, routePts, courier.progress);
          updateETA();
          updateProgressUI();
          setOrderProgress(currentOrderId, courier.progress);
          if(courier.progress>0.48 && courier.progress<0.52 && !startRideDetail.__hitLaundry){ notify('Cucian sedang diproses di laundry üß∫'); startRideDetail.__hitLaundry=true; }
          if(courier.progress>0.9 && !startRideDetail.__almostHome){ notify('Kurir hampir sampai rumah üö™'); startRideDetail.__almostHome=true; }
          if(courier.progress>=1){
            notify('Pesanan selesai ‚úÖ');
            clearInterval(rideTimerDetail); courier.active=false; startRideDetail.__hitLaundry=false; startRideDetail.__almostHome=false;
            toast('Terima kasih telah menggunakan LaundryZone!');
            setOrderProgress(currentOrderId, 1);
            render();
          }
        }
      }, 400);
    }
    function pauseRideDetail(){ clearInterval(rideTimerDetail); courier.active=false; toast('Rute dijeda ‚è∏Ô∏è'); }
    function resetRideDetail(){ clearInterval(rideTimerDetail); courier.progress=0; courier.active=false; updateRoutes(); updateETA(true); updateProgressUI(); setOrderProgress(currentOrderId, 0); toast('Rute direset üîÑ'); }

    function updateETA(manual=false){
      const total=routeLength(routePts); 
      const ord = orders.find(o=>o.id===currentOrderId);
      const progress = ord ? (ord.progress||0) : (courier.progress||0);
      const remaining=(1-progress)*total;
      const speed=BASE_PX_PER_MIN;
      const min=Math.max(1, Math.round(remaining/speed));
      $('#eta').textContent=`ETA: ${min} menit`;
      if(manual) notify('ETA diperbarui: '+min+' menit');
    }

    // ===== Chat dengan variasi jawaban (Kurir)
    const replyPool={
      general:[
        'Siap kak, saya teruskan ya. üôå',
        'Baik kak, segera diproses. üëç',
        'Noted ya kak. Terima kasih! üòä'
      ],
      eta:[
        ()=>`Perkiraan sampai ${$('#eta').textContent.replace('ETA: ','')}.`,
        ()=>`ETA saat ini ${$('#eta').textContent.replace('ETA: ','')}, kak.`,
        ()=>`Kurang lebih ${$('#eta').textContent.replace('ETA: ','')} ya kak.`
      ],
      shoe:[
        'Untuk cuci sepatu estimasinya 1 hari kerja üëü',
        'Sepatu biasanya selesai ¬±1 hari, kak.',
        'Cuci sepatu kami butuh sekitar 24 jam, kak.'
      ],
      thanks:[
        'Sama-sama kak! üôè',
        'Terima kasih kembali üòä',
        'Senang membantu!'
      ],
      request:[
        'Oke, saya catat ya kak. üôè',
        'Siap, akan saya perhatikan. üëç',
        'Baik, sudah dicatat ya kak.'
      ]
    };

    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function elMsg(txt,me=false){ const d=document.createElement('div'); d.className='msg '+(me?'me':'them'); d.textContent=typeof txt==='function'?txt():txt; return d; }
    function presetChat(){ const log=$('#chatLog'); if(!log) return; log.innerHTML=''; log.appendChild(elMsg('Halo, saya kurir LaundryZone. Saya jemput dulu ya üöö')); log.appendChild(elMsg('Siap kak, ditunggu üôå', true)); log.scrollTop=log.scrollHeight; }
    function sendMsg(){ const inp=$('#chatTxt'); if(!inp.value.trim()) return; const log=$('#chatLog'); const text=inp.value; const userText=text.toLowerCase(); log.appendChild(elMsg(text,true)); log.scrollTop=log.scrollHeight; inp.value=''; setTimeout(()=>{
        let reply=pick(replyPool.general);
        if(userText.includes('berapa')||userText.includes('eta')||userText.includes('sampai')) reply=pick(replyPool.eta);
        if(userText.includes('sepatu')||userText.includes('shoes')) reply=pick(replyPool.shoe);
        if(userText.includes('terima kasih')||userText.includes('makasih')||userText.includes('thanks')) reply=pick(replyPool.thanks);
        if(userText.includes('tolong')||userText.includes('mohon')||userText.includes('please')) reply=pick(replyPool.request);
        log.appendChild(elMsg(reply)); log.scrollTop=log.scrollHeight; 
    },700); }

    // ===== Chat ke Laundry (BARU, customer-centric)
    let currentLaundryChat={id:null,name:null};
    const replyPoolLaundry={
      general:[
        'Halo kak, LaundryZone store di sini. Ada yang bisa dibantu? üòä',
        'Siap kak, kami bantu ya. üôå',
        'Noted kak, terima kasih sudah menghubungi kami.'
      ],
      price:[
        'Untuk kiloan mulai Rp7.000/kg, express Rp10.000/kg.',
        'Sepatu Rp25.000/psg, jas/dry clean Rp40.000/item ya kak.',
        'Ada promo aktif: Cashback 10% untuk beberapa outlet.'
      ],
      time:[
        'Estimasi selesai 1‚Äì2 hari untuk reguler. Express bisa lebih cepat.',
        'Kalau antrean normal, besok sudah selesai kak. üôè',
        'Untuk sepatu biasanya 24 jam.'
      ],
      thanks:[
        'Terima kasih kembali kak! üòä',
        'Sama-sama kak, senang membantu! üôè',
        'Siap, ditunggu pesanannya ya kak.'
      ]
    };

    function openLaundryChat(id,name){
      currentLaundryChat={id,name};
      $('#laundryChatTitle').textContent = 'Chat ‚Äî '+name;
      const log=$('#laundryChatLog');
      log.innerHTML='';
      log.appendChild(elMsg('Halo kak, '+name+' di sini. Ada yang bisa kami bantu?')); 
      toggleLaundryChat(true);
      setTimeout(()=>{log.scrollTop=log.scrollHeight},0);
    }
    function toggleLaundryChat(show){ $('#laundryChatModal').style.display = show?'flex':'none'; }
    function sendLaundryMsg(){
      const inp=$('#laundryChatTxt'); const txt=inp.value.trim(); if(!txt) return; const log=$('#laundryChatLog');
      log.appendChild(elMsg(txt,true)); log.scrollTop=log.scrollHeight; inp.value='';
      const t=txt.toLowerCase();
      setTimeout(()=>{
        let reply=pick(replyPoolLaundry.general);
        if(t.includes('harga')||t.includes('biaya')||t.includes('tarif')) reply=pick(replyPoolLaundry.price);
        if(t.includes('estimasi')||t.includes('kapan')||t.includes('waktu')||t.includes('selesai')) reply=pick(replyPoolLaundry.time);
        if(t.includes('terima kasih')||t.includes('makasih')||t.includes('thanks')) reply=pick(replyPoolLaundry.thanks);
        log.appendChild(elMsg(reply)); log.scrollTop=log.scrollHeight;
      },650);
    }

    // ===== Payment Modal + QR dummy
    function togglePay(show){ $('#payModal').style.display = show?'flex':'none'; if(show) drawQR(); }
    function drawQR(){ const c=$('#qr'); const ctx=c.getContext('2d'); const s=20; ctx.fillStyle='#fff'; ctx.fillRect(0,0,c.width,c.height); for(let y=0;y<c.height;y+=s){ for(let x=0;x<c.width;x+=s){ if((x+y)%40===0 || Math.random()>.75){ ctx.fillStyle='#000'; ctx.fillRect(x+2,y+2,s-4,s-4);} } } ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--blue'); ctx.fillRect(10,10,60,60); ctx.fillRect(c.width-70,10,60,60); ctx.fillRect(10,c.height-70,60,60); }

    // ===== Shortcuts
    document.addEventListener('keydown',(e)=>{
      if(e.key==='g') { themeToggle.checked=!themeToggle.checked; applyTheme(); }
      if(e.key==='/'){ e.preventDefault(); navigate('order'); }
    });

    // ===== Init
    function init(){
      const dark=loadLS('THEME_DARK',false); themeToggle.checked=!!dark; applyTheme();
      $('#langBtn').textContent = LANG==='id'?'üáÆüá© ID':'üá¨üáß EN';
      $$('#mainMenu button').forEach(b=> b.onclick=()=>navigate(b.dataset.view));
      moveInk($$('#mainMenu button')[0]);
      render(false);
    }

    init();
  </script>
</body>
</html>
